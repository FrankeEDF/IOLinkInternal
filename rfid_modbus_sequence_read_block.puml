@startuml RFID_Modbus_Communication_Sequence
!theme plain
title RFID MIFARE Block Read Operation - Communication Sequence

participant "PC or\n MultiIO" as PC
participant "Firmware\n(Modbus Slave)" as FW
participant "RFID Reader\n(UART)" as RFID

== MIFARE Block Read Operation ==

PC -> FW: **Modbus Write Single Register**\nFunc: 0x06\nAddr: 1016\nValue: block_num | (key_select << 8)\n[Key A=0x0000, Key B=0x0100]
FW -> FW: rfidControl.SetBlockNumber(value)\nStore block number and key selection
FW --> PC: Modbus Response

PC -> FW: **Modbus Read Holding Registers**\nFunc: 0x03\nAddr: 1018\nCount: 8 registers (16 bytes)


FW -> RFID: **Stop continuous mode**\n(if active)
RFID --> FW: ACK


FW -> RFID: **UART Login Command**\nLogin with Key A/B
RFID --> FW: Login Response

FW -> RFID: **UART Authenticate**\nBlock sector authentication
RFID --> FW: Auth Response


FW -> RFID: **UART Read Block**\nCmd: 0x17\nBlock Nr: [block_num]

alt Success
    RFID --> FW: **UART Response**\nCmd: 0x17\nData: 16 bytes block data

    FW -> FW: memcpy block data


    FW -> RFID: **Start continuous mode**
    RFID --> FW: ACK

    FW --> PC: **Modbus Response**\nFunc: 0x03\n8 registers (16 bytes data)

else Error
    RFID --> FW: **UART Error Response**

    FW -> FW: Set lastError

    FW -> RFID: **Start continuous mode**
    RFID --> FW: ACK

    FW --> PC: **Modbus Response**\nwith error or zeros
end

PC -> FW: **Modbus Read Register**\nFunc: 0x03\nAddr: 1017 (lastError)\nCount: 1
FW --> PC: Error code / Success (0x00)


== Key Information ==
note right of PC
**Modbus Registers:**
- 1016: Block number + Key select
- 1017: Last error code
- 1018-1025: Block data (8 regs = 16 bytes)

**Key Selection (Register 1016):**
- Bits 0-7: Block number (0-63)
- Bit 8: Key selection (0=A, 1=B)
- Bits 9-15: Reserved

**Important: No caching!**
The RFID communication happens
directly during the Modbus request:
- Modbus Read 1018 → RFID operations → Response
- Modbus Write 1018 → RFID operations → Response

**Sequence per Modbus Request:**
1. Stop continuous transmission
2. Login with Key A/B
3. Authenticate sector
4. Read/Write block
5. Restart continuous transmission
6. Return Modbus response

**UART Protocol:**
- Baud: 115200
- Data: 8 bit
- Parity: Even
- Stop: 1 bit

**RFID Commands:**
- 0x17: Read MIFARE block
- 0x18: Write MIFARE block
- 0x22: Login/Authenticate
- 0x23: Continuous UID read
end note

@enduml
